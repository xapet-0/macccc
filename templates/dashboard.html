<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mariam Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .quest-node {
      width: 50px;
      height: 50px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      font-size: 0.75rem;
      font-weight: 600;
      color: #0b0f19;
      cursor: pointer;
    }

    .quest-locked {
      background: #4b5563;
      color: #e5e7eb;
    }

    .quest-active {
      background: #00eaff;
      animation: pulse 2s infinite;
      color: #0b0f19;
    }

    .quest-completed {
      background: #facc15;
      color: #1f2937;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 234, 255, 0.7);
      }
      70% {
        box-shadow: 0 0 0 18px rgba(0, 234, 255, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(0, 234, 255, 0);
      }
    }

    .tooltip {
      position: absolute;
      top: -32px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9);
      color: #f8fafc;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .quest-node:hover .tooltip {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-[#0b0f19] text-slate-100 min-h-screen">
  <header class="px-10 py-6 border-b border-slate-800 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-[#00eaff]">Mariam | Holy Graph</h1>
      <p class="text-sm text-slate-400">Solo Leveling Dashboard</p>
    </div>
    <div class="flex items-center gap-6">
      <div>
        <p class="text-xs uppercase text-slate-400">Level</p>
        <p class="text-lg font-semibold">{{ player.level if player else 1 }}</p>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-400">HP</p>
        <div class="w-40 h-3 bg-slate-800 rounded-full overflow-hidden">
          <div class="h-full bg-red-500" style="width: {{ player.hp if player else 100 }}%"></div>
        </div>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-400">MP</p>
        <div class="w-40 h-3 bg-slate-800 rounded-full overflow-hidden">
          <div class="h-full bg-blue-500" style="width: {{ player.mana if player else 100 }}%"></div>
        </div>
      </div>
      <div>
        <p class="text-xs uppercase text-slate-400">Gold</p>
        <p class="text-lg font-semibold" id="wallet-count">{{ player.wallet if player else 0 }}</p>
      </div>
    </div>
  </header>

  <main class="relative px-10 py-10">
    <div class="relative w-full max-w-5xl h-[500px] mx-auto border border-slate-800 rounded-2xl bg-[#0f172a]/60 overflow-hidden">
      <svg class="absolute inset-0 w-full h-full">
        {% for edge in edges %}
          <line
            x1="{{ edge[0].graph_x + 25 }}"
            y1="{{ edge[0].graph_y + 25 }}"
            x2="{{ edge[1].graph_x + 25 }}"
            y2="{{ edge[1].graph_y + 25 }}"
            stroke="#1e293b"
            stroke-width="2"
          />
        {% endfor %}
      </svg>

      {% for quest in quests %}
        {% set status_class = 'quest-locked' if quest.status == 'LOCKED' else 'quest-active' if quest.status == 'ACTIVE' else 'quest-completed' %}
        <div
          class="quest-node {{ status_class }}"
          style="left: {{ quest.graph_x }}px; top: {{ quest.graph_y }}px;"
          data-quest-id="{{ quest.id }}"
          data-quest-title="{{ quest.title }}"
          data-quest-status="{{ quest.status }}"
          data-subject-url="{{ url_for('download_subject', quest_id=quest.id) }}"
        >
          {% if quest.status == 'LOCKED' %}
            ðŸ”’
            <span class="tooltip">Locked Loot âœ¨</span>
          {% elif quest.status == 'ACTIVE' %}
            â–¶
          {% else %}
            â˜…
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </main>

  <div id="quest-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
    <div class="bg-[#111827] border border-[#00eaff] rounded-2xl p-6 w-full max-w-lg shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modal-title" class="text-xl text-[#00eaff] font-semibold">Quest</h2>
        <button id="modal-close" class="text-slate-400 hover:text-white">âœ•</button>
      </div>
      <p class="text-sm text-slate-400 mb-4">Prepare for active mode. Timing is strict.</p>
      <div class="flex items-center gap-4 mb-4">
        <button id="start-btn" class="px-4 py-2 bg-[#00eaff]/20 border border-[#00eaff] rounded-lg">Start</button>
        <button id="stop-btn" class="px-4 py-2 bg-red-500/20 border border-red-400 rounded-lg">Stop</button>
        <a id="subject-link" href="#" class="text-sm text-[#00eaff] underline">Download Subject</a>
      </div>
      <div class="text-lg font-semibold text-white mb-4">Timer: <span id="timer">00:00</span></div>
      <form id="submission-form" class="space-y-3" enctype="multipart/form-data">
        <label class="text-sm text-slate-400">Submit Quest Proof</label>
        <input type="file" name="submission" class="block w-full text-sm text-slate-300" required />
        <button type="submit" class="px-4 py-2 bg-[#00eaff]/20 border border-[#00eaff] rounded-lg">Submit</button>
      </form>
      <p id="submission-result" class="text-sm text-slate-300 mt-3"></p>
    </div>
  </div>

  <script>
    const modal = document.getElementById("quest-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalClose = document.getElementById("modal-close");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const timerEl = document.getElementById("timer");
    const subjectLink = document.getElementById("subject-link");
    const submissionForm = document.getElementById("submission-form");
    const submissionResult = document.getElementById("submission-result");
    const walletCount = document.getElementById("wallet-count");

    let activeQuestId = null;
    let timerInterval = null;
    let heartbeatInterval = null;
    let secondsElapsed = 0;

    function speak(text) {
      if (!window.speechSynthesis) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1;
      utterance.pitch = 1.1;
      window.speechSynthesis.speak(utterance);
    }

    function openModal(quest) {
      modalTitle.textContent = quest.title;
      subjectLink.href = quest.subjectUrl;
      activeQuestId = quest.id;
      submissionForm.dataset.questId = quest.id;
      submissionResult.textContent = "";
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    document.querySelectorAll(".quest-node").forEach((node) => {
      node.addEventListener("click", () => {
        openModal({
          id: node.dataset.questId,
          title: node.dataset.questTitle,
          status: node.dataset.questStatus,
          subjectUrl: node.dataset.subjectUrl,
        });
      });
    });

    modalClose.addEventListener("click", closeModal);

    function updateTimer() {
      secondsElapsed += 1;
      const minutes = String(Math.floor(secondsElapsed / 60)).padStart(2, "0");
      const seconds = String(secondsElapsed % 60).padStart(2, "0");
      timerEl.textContent = `${minutes}:${seconds}`;
    }

    startBtn.addEventListener("click", async () => {
      if (!activeQuestId) return;
      secondsElapsed = 0;
      timerEl.textContent = "00:00";
      if (timerInterval) clearInterval(timerInterval);
      if (heartbeatInterval) clearInterval(heartbeatInterval);

      await fetch("/start_session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quest_id: activeQuestId }),
      });

      timerInterval = setInterval(updateTimer, 1000);
      heartbeatInterval = setInterval(async () => {
        const response = await fetch("/track_time", { method: "POST" });
        if (response.ok) {
          const data = await response.json();
          walletCount.textContent = data.wallet;
        }
      }, 60000);

      speak("System Online. Good luck.");
    });

    stopBtn.addEventListener("click", async () => {
      if (timerInterval) clearInterval(timerInterval);
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      await fetch("/stop_session", { method: "POST" });
    });

    submissionForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const questId = submissionForm.dataset.questId;
      const formData = new FormData(submissionForm);
      const response = await fetch(`/submit_quest/${questId}`, {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      if (result.result === "success") {
        submissionResult.textContent = `Quest Cleared. Score: ${result.score}`;
        speak("Quest Cleared. Loot Unlocked.");
      } else {
        submissionResult.textContent = `Disappointing result. Score: ${result.score}`;
        speak("Disappointing result. HP deducted.");
      }
    });
  </script>
</body>
</html>
